<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Cadastro - BS Psicologia</title>
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>

    <div class="register-wrapper">
        <div class="register-card">
            <h2 style="color: var(--color-primary);">Cadastrar Novo Usuário</h2>
            <p style="margin-bottom: 1.5rem;">Preencha os dados para registrar um novo membro na equipe ou paciente.</p>

            <form id="registerForm">
                
                <div style="margin-bottom: 1.5rem;">
                    <label for="role" style="font-weight: 600;">Tipo de Conta</label>
                    <select id="role" required>
                        <option value="" disabled selected>Carregando permissões...</option>
                        </select>
                </div>

                <div class="form-grid">
                    <div>
                        <label for="name">Nome Completo</label>
                        <input type="text" id="name" placeholder="Ex: João Silva" required>
                    </div>
                    
                    <div>
                        <label for="phone">Telefone/WhatsApp</label>
                        <input type="tel" id="phone" placeholder="(XX) 99999-9999">
                    </div>
                </div>

                <div id="psiFields" class="hidden" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #bde0fe;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Dados Profissionais</h4>
                    <div class="form-grid">
                        <div>
                            <label for="crp">Número do CRP</label>
                            <input type="text" id="crp" placeholder="07/XXXXX">
                        </div>
                        <div>
                            <label for="abordagem">Especialidade</label>
                            <input type="text" id="abordagem" value="TCC / Terapia do Esquema">
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div>
                        <label for="email">E-mail de Acesso</label>
                        <input type="email" id="email" required>
                    </div>
                    <div>
                        <label for="password">Senha Inicial</label>
                        <input type="password" id="password" required minlength="6">
                    </div>
                </div>

                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">
                    Realizar Cadastro
                </button>
            </form>
            
            <div style="text-align: center; margin-top: 1rem;">
                <a href="index.html" class="btn-secondary" style="text-decoration: none; font-size: 0.9rem;">Voltar ao Painel</a>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa do caminho correto
        import { auth, db } from './assets/firebase.js';
        import { createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const roleSelect = document.getElementById('role');
        const psiFields = document.getElementById('psiFields');
        const form = document.getElementById('registerForm');
        
        let currentUserRole = null; // Armazena quem está fazendo o cadastro

        // 1. Verifica quem está logado e define o que ele pode ver
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Busca os dados de quem está logado no banco de dados
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role; // Ex: 'lider', 'psi' ou 'recep'
                        preencherOpcoes(currentUserRole);
                    } else {
                        // Se o usuário logado não tem perfil no banco (ex: Admin manual)
                        // Vamos assumir que é Líder para o primeiro acesso
                        console.log("Usuário sem perfil definido, assumindo Líder temporário.");
                        preencherOpcoes('lider'); 
                    }
                } catch (error) {
                    console.error("Erro ao buscar permissões:", error);
                    alert("Erro de permissão. Verifique sua conexão.");
                }
            } else {
                // Se não estiver logado, manda pro login
                alert("Você precisa estar logado para cadastrar alguém.");
                window.location.href = "index.html";
            }
        });

        // 2. Define a hierarquia
        function preencherOpcoes(role) {
            roleSelect.innerHTML = '<option value="" disabled selected>Selecione o nível...</option>';
            
            const regras = {
                'lider': [
                    { val: 'psi', txt: 'Psicólogo' },
                    { val: 'recep', txt: 'Recepcionista' },
                    { val: 'paciente', txt: 'Paciente' }
                ],
                'psi': [
                    { val: 'paciente', txt: 'Paciente' }
                ],
                'recep': [
                    { val: 'paciente', txt: 'Paciente' }
                ]
            };

            const permitidos = regras[role] || [];

            permitidos.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.val;
                option.textContent = opt.txt;
                roleSelect.appendChild(option);
            });
        }

        // 3. Monitora mudança no select para mostrar CRP
        roleSelect.addEventListener('change', function() {
            if (this.value === 'psi') {
                psiFields.classList.remove('hidden');
                document.getElementById('crp').required = true;
            } else {
                psiFields.classList.add('hidden');
                document.getElementById('crp').required = false;
            }
        });

        // 4. Salva no Firebase
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button');
            const textoOriginal = btn.innerText;
            
            btn.innerText = "Cadastrando...";
            btn.disabled = true;

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nome = document.getElementById('name').value;
            const role = roleSelect.value;
            const telefone = document.getElementById('phone').value;
            
            // Dados específicos
            const dadosExtras = {};
            if (role === 'psi') {
                dadosExtras.crp = document.getElementById('crp').value;
                dadosExtras.abordagem = document.getElementById('abordagem').value;
            }

            try {
                // AVISO TÉCNICO: O método createUserWithEmailAndPassword automaticamente loga o NOVO usuário.
                // Em um app real, usaríamos uma Cloud Function para criar sem deslogar o admin.
                // Como estamos fazendo front-end puro, ao criar, ele vai trocar a sessão.
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;

                // Salva os dados detalhados no Firestore (Banco de Dados)
                await setDoc(doc(db, "users", newUser.uid), {
                    uid: newUser.uid,
                    nome: nome,
                    email: email,
                    role: role,
                    telefone: telefone,
                    criadoEm: serverTimestamp(),
                    ...dadosExtras
                });

                alert("Usuário cadastrado com sucesso!");
                form.reset();
                // Opcional: Redirecionar ou pedir login novamente
                window.location.href = "index.html"; 

            } catch (error) {
                console.error(error);
                alert("Erro ao cadastrar: " + error.message);
            } finally {
                btn.innerText = textoOriginal;
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
